---
- name: Check if proxmox.fact file exists
  ansible.builtin.stat:
    path: "{{ default_facts_path }}/proxmox.fact"
  register: proxmox_fact_file

- name: Generate token identifier for each host
  ansible.builtin.set_fact:
    token_id: "{{ proxmox_default_admin_token }}-{{ inventory_hostname }}"

- name: Attempt to list existing authentication tokens
  ansible.builtin.command:
    argv:
      - pveum
      - user
      - token
      - list
      - "{{ item.name }}"
  with_items: "{{ proxmox_admin_accounts }}"
  ignore_errors: True
  register: existing_tokens

- name: Attempt to create authentication tokens if they don't exist
  ansible.builtin.command:
    argv:
      - pveum
      - user
      - token
      - add
      - "{{ item.item.name }}"
      - "{{ token_id }}"
      - -privsep
      - "0"
      - -comment
      - "{{ proxmox_default_admin_token_comment }}"
  with_items: "{{ existing_tokens.results }}"
  when: token_id not in item.stdout
  notify: 
    - Save Proxmox Admin Token
    - Refresh Facts
...
