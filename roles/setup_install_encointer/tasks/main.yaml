---
- name: Ensure group {{ encointer_user }} exists
  ansible.builtin.group:
    name: "{{ encointer_user }}"
    state: present
    system: True
  notify:
    - Add type of service fact

- name: Ensure user {{ encointer_user }} exists
  ansible.builtin.user:
    append: True
    comment: encointer service user
    create_home: False
    group: "{{ encointer_user }}"
    groups: sudo
    home: "{{ encointer_base }}"
    name: "{{ encointer_user }}"
    shell: "{{ default_shell }}"
    state: present
    system: True

- name: Ensure user {{ encointer_user }} owns {{ encointer_base }}
  ansible.builtin.file:
    path: "{{ item }}"
    owner: "{{ encointer_user }}"
    group: "{{ encointer_user }}"
    mode: '0755'
    state: directory
  with_items:
    - "{{ encointer_base }}"

- name: Refresh facts before install
  ansible.builtin.setup:

- name: Install Encointer v{{ encointer_version }}
  ansible.builtin.get_url:
    url: "{{ encointer_download_url }}"
    dest: "{{ encointer_base }}/encointer-v{{ encointer_version }}"
    mode: "u+rwx"
    owner: "{{ encointer_user }}"
    group: "{{ encointer_user }}"
  when:
    - ansible_local['noderole']['node']['pinned'] != "True"
    - ansible_local['noderole']['node']['version'] != encointer_version
  notify:
    - Add Encointer service version
    - Add Service Pinned Status
    - Stop Encointer
    - Symlink Encointer release
    - Symlink binary executable
    - Systemd daemon-reload
    - Restart Encointer

- name: Refresh facts after install
  ansible.builtin.setup:

- name: Copy Encointer systemd service for specific node type
  ansible.builtin.template:
    src: "{{ 'encointer_' + node_type + '.service.j2' }}"
    dest: "{{ encointer_base }}/encointer.service"
    owner: "{{ encointer_user }}"
    group: "{{ encointer_user }}"
    mode: '0644'
  vars:
    node_type: "{{ ansible_local['noderole']['node']['type'] }}"
  when:
    - node_type in ["collator", "bootnode", "endpoint"]

- name: Symlink Encointer service to systemd
  ansible.builtin.file:
    src: "{{ encointer_base }}/encointer.service"
    dest: "/etc/systemd/system/encointer.service"
    state: link
    force: True
    owner: "root"
    group: "root"
    mode: '0644'
  notify:
    - Stop Encointer
    - Systemd daemon-reload
    - Restart Encointer
...
