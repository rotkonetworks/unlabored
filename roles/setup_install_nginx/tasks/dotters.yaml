---
# Install SSH key from value
- name: Install SSH key
  ansible.builtin.copy:
    content: "{{ default_dotters_private_key }}"
    force: yes
    dest: '/root/.ssh/dotters_key'
    mode: '0600'

- name: Ensure /opt/github exists
  ansible.builtin.file:
    path: /opt/github
    state: directory
    mode: '0755'

- name: Install/Update rpc.dotters.network SSL
  become: True
  block:
    - name: Git update
      ansible.builtin.git:
        repo: '{{ default_dotters_repository }}'
        dest: '/opt/github/dotters-ssl'
        key_file: '/root/.ssh/dotters_key'
        update: yes
        force: yes
      environment:
        GIT_SSH_COMMAND: "ssh -i /root/.ssh/dotters_key -o IdentitiesOnly=yes"
      tags:
        - skip_ansible_later

    - name: Check new expiration date
      ansible.builtin.shell: |
        set -o pipefail
        openssl x509 -enddate -noout -in /opt/github/dotters-ssl/cert/cert.pem | cut -f2 -d'='
      register: expiration_date_new_dotters
      args:
        executable: /bin/bash

# Ensure destination directories exist
- name: Ensure directories exist for archive and live certificates
  ansible.builtin.file:
    path: "{{ item }}"
    state: directory
    mode: '0755'
  loop:
    - "/etc/letsencrypt/archive/{{ default_public_dns_dotters }}"
    - "/etc/letsencrypt/live/{{ default_public_dns_dotters }}"

# Copy the certificates to the archive folder
- name: Copy SSL certificates to archive directory
  ansible.builtin.copy:
    src: "/opt/github/dotters-ssl/cert/{{ item }}"
    dest: "/etc/letsencrypt/archive/{{ default_public_dns_dotters }}/{{ item }}"
    mode: '0644'
    remote_src: yes
  loop:
    - cert.pem
    - chain.pem
    - fullchain.pem
    - privkey.pem

# Create symlinks in the live directory
- name: Create symlinks in live directory
  ansible.builtin.file:
    src: "/etc/letsencrypt/archive/{{ default_public_dns_dotters }}/{{ item }}"
    dest: "/etc/letsencrypt/live/{{ default_public_dns_dotters }}/{{ item }}"
    state: link
  loop:
    - cert.pem
    - chain.pem
    - fullchain.pem
    - privkey.pem

# Setup NGINX configuration directories
- name: Ensure NGINX configuration directories exist
  ansible.builtin.file:
    path: "/etc/nginx/{{ item }}"
    state: directory
    mode: '0755'
  loop:
    - sites-available
    - sites-enabled

# Configure NGINX for HTTPS
- name: Apply HTTPS configuration to NGINX
  ansible.builtin.template:
    src: https-{{ default_node_type }}-dotters.j2
    dest: "/etc/nginx/sites-available/{{ default_public_dns_dotters }}"
    mode: '0755'

# Enable the HTTPS configuration in NGINX
- name: Enable HTTPS configuration for NGINX
  ansible.builtin.file:
    src: "/etc/nginx/sites-available/{{ default_public_dns_dotters }}"
    dest: "/etc/nginx/sites-enabled/{{ default_public_dns_dotters }}"
    state: link
  notify: Reload nginx
...
