---
# Install SSH key from value
- name: Install SSH key
  ansible.builtin.copy:
    content: "{{ default_ibp_private_key }}"
    dest: '/root/.ssh/ibp_key'
    mode: '0600'

- name: Add SSH key to agent
  ansible.builtin.shell: |
    eval $(ssh-agent -s)
    ssh-add /root/.ssh/ibp_key
  environment:
    SSH_AUTH_SOCK: /tmp/ssh-agent.sock

- name: Install/Update ibp.network SSL
  become: True
  block:
    - name: Git update
      ansible.builtin.git:
        repo: 'git@github.com:GATOTECH-LTD/ibp-ssl.git'
        dest: '/opt/github/ibp-ssl'
        key_file: '/root/.ssh/ibp_key'
        update: yes

    - name: "Check new expiration date"
      ansible.builtin.shell: "openssl x509 -enddate -noout -in /opt/github/ibp-ssl/cert/cert.pem | cut -f2 -d'='"
      register: expiration_date_new_ibp

# Ensure destination directories exist
- name: Ensure directories exist for archive and live certificates
  ansible.builtin.file:
    path: "{{ item }}"
    state: directory
    mode: '0755'
  loop:
    - "/etc/letsencrypt/archive/ibp.network"
    - "/etc/letsencrypt/live/ibp.network"

# Copy the certificates to the archive folder
- name: Copy SSL certificates to archive directory
  ansible.builtin.copy:
    src: "/opt/github/ibp-ssl/cert/{{ item }}"
    dest: "/etc/letsencrypt/archive/ibp.network/{{ item }}"
    mode: '0644'
  loop:
    - cert.pem
    - chain.pem
    - fullchain.pem
    - privkey.pem

# Create symlinks in the live directory
- name: Create symlinks in live directory
  ansible.builtin.file:
    src: "/etc/letsencrypt/archive/ibp.network/{{ item }}"
    dest: "/etc/letsencrypt/live/ibp.network/{{ item }}"
    state: link
  loop:
    - cert.pem
    - chain.pem
    - fullchain.pem
    - privkey.pem

# Setup NGINX configuration directories
- name: Ensure NGINX configuration directories exist
  ansible.builtin.file:
    path: "/etc/nginx/{{ item }}"
    state: directory
    mode: '0755'
  loop:
    - sites-available
    - sites-enabled

# Configure NGINX for HTTPS
- name: Apply HTTPS configuration to NGINX
  ansible.builtin.template:
    src: https-{{ default_node_type }}-ibp.j2
    dest: "/etc/nginx/sites-available/{{ default_public_dns_ibp }}"
    mode: '0755'

# Enable the HTTPS configuration in NGINX
- name: Enable HTTPS configuration for NGINX
  ansible.builtin.file:
    src: "/etc/nginx/sites-available/{{ default_public_dns_ibp }}"
    dest: "/etc/nginx/sites-enabled/{{ default_public_dns_ibp }}"
    state: link
  notify: Reload nginx
...
