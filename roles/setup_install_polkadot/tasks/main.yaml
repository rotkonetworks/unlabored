---

- name: Ensure group {{ polkadot_user }} exists
  ansible.builtin.group:
    name: "{{ polkadot_user }}"
    state: present
    system: True

- name: Ensure user {{ polkadot_user }} exists without unnecessary privileges
  ansible.builtin.user:
    append: True
    comment: polkadot service user
    create_home: False
    group: "{{ polkadot_user }}"
    groups: []
    home: "{{ polkadot_base }}"
    name: "{{ polkadot_user }}"
    shell: "/sbin/nologin"
    state: present
    system: True

- name: Ensure user {{ polkadot_user }} owns {{ polkadot_base }}
  ansible.builtin.file:
    path: "{{ polkadot_base }}"
    owner: "{{ polkadot_user }}"
    group: "{{ polkadot_user }}"
    mode: '0750'
    state: directory

- name: Copy Polkadot systemd service for specific node type
  ansible.builtin.template:
    src: "{{ 'polkadot_' + node_type + '.service.j2' }}"
    dest: "{{ polkadot_base }}/polkadot.service"
    owner: "{{ polkadot_user }}"
    group: "{{ polkadot_user }}"
    mode: '0640'
  vars:
    node_type: "{{ ansible_local['noderole']['node']['type'] }}"
  when: node_type in ["validator", "bootnode", "endpoint"]

- name: Symlink Polkadot service to systemd
  ansible.builtin.file:
    src: "{{ polkadot_base }}/polkadot.service"
    dest: "/etc/systemd/system/polkadot.service"
    state: link
    force: True
    owner: "root"
    group: "root"
    mode: '0644'

- name: Install polkadot v{{ polkadot_version }}
  ansible.builtin.get_url:
    url: "{{ polkadot_download_url }}"
    dest: "{{ polkadot_base }}/polkadot-v{{ polkadot_version }}"
    mode: "u+r-x"
    owner: "{{ polkadot_user }}"
    group: "{{ polkadot_user }}"
  register: download_result
  notify:
  - Stop Polkadot
  - Symlink Polkadot release
  - Symlink binary executable
  - Symlink Polkadot service to systemd
  - Systemd daemon-reload
  - Start Polkadot
  when:
    - ansible_local['noderole']['node']['pinned'] != "True"
    - ansible_local['noderole']['node']['version'] != polkadot_version
...
