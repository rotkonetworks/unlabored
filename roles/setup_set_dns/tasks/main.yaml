---
- name: Backup current resolv.conf
  ansible.builtin.copy:
    src: /etc/resolv.conf
    dest: /etc/resolv.conf.backup.{{ ansible_date_time.epoch }}
    remote_src: true
    mode: "0644"

- name: Update resolv.conf with Quad9 DNS
  ansible.builtin.template:
    src: resolv.conf.j2
    dest: /etc/resolv.conf
    mode: "0644"
    owner: root
    group: root
    backup: yes

- name: Ensure resolv.conf is not immutable
  ansible.builtin.file:
    path: /etc/resolv.conf
    attributes: "-i"
  ignore_errors: true

- name: Disable systemd-resolved if present (Ubuntu/Debian)
  ansible.builtin.systemd:
    name: systemd-resolved
    state: stopped
    enabled: false
  when: ansible_os_family == "Debian"
  ignore_errors: true

- name: Remove systemd-resolved symlink if exists
  ansible.builtin.file:
    path: /etc/resolv.conf
    state: absent
  when:
    - ansible_os_family == "Debian"
    - ansible_facts['stat']['exists'] is defined
    - ansible_facts['stat']['islnk'] is defined
  ignore_errors: true

# - name: Create new resolv.conf with Quad9 DNS
#   ansible.builtin.copy:
#     content: |
#       # Quad9 DNS servers
#       nameserver 9.9.9.9
#       nameserver 149.112.112.112
#       # IPv6 Quad9 DNS (optional)
#       nameserver 2620:fe::fe
#       nameserver 2620:fe::9
#     dest: /etc/resolv.conf
#     mode: '0644'
#     owner: root
#     group: root

- name: Verify DNS resolution
  ansible.builtin.command: nslookup google.com 9.9.9.9
  register: dns_test
  changed_when: false
  failed_when: false

- name: Display DNS test result
  ansible.builtin.debug:
    msg: "DNS test result: {{ dns_test.stdout_lines | default(['Test failed']) }}"
  when: dns_test is defined

